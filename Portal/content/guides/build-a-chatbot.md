# Build a conversational Chatbot


![alt text](https://res.cloudinary.com/apimatic/image/upload/v1655493774/6077d3bf745665b6417daf05/6077d3bf745665b6417daf05--whatsapp-poc-2.gif)


This tutorial will walk you through the process of building a Chatbot that is able to talk about virtually anything using the .Net SDK for Whatsapp's Cloud API.

The source code for this Chatbot is available on [github](https://github.com/apimatic/whatsapp-chatbot) 

## Whatsapp Setup

1. Setup a Meta developer account and create an App by following the [getting started guide](https://developers.facebook.com/docs/whatsapp/cloud-api/get-started).
2. Select .Net from the dropdown menu and then click on the 'Get SDK' button to download the .Net SDK as a .zip file or clone it from github.


![alt text](https://res.cloudinary.com/apimatic/image/upload/v1655450098/6077d3bf745665b6417daf05/6077d3bf745665b6417daf05--Screenshot%202022-06-16%20at%2011.49.25%20PM%20%281%29.png)

3. Create a new Web API project in Visual Studio.  Add the downloaded SDK project to the newly created solution.

4. Create a controller with 2 endpoints - `GET /webhook` and `POST /webhook`. The `GET` endpoint will be used to setup and verify the webhook while the `POST` endpoint will be used to receive webhook notifications from Whatsapp when a messsage is received. Refer to the [webhooks](https://developers.facebook.com/docs/whatsapp/cloud-api/webhooks/components) documentation for information regarding the Notification Object payload. 

```
[HttpGet("webhook")]
        public ActionResult<string> GetWebhook(
            [FromQuery(Name = "hub.mode")] string hubMode,
            [FromQuery(Name = "hub.challenge")] int hubChallenge,
            [FromQuery(Name = "hub.verify_token")] string hubVerifyToken)
        {
 // verify the token and respond
        }
```

```
[HttpPost("webhook")]
    public ActionResult PostWebhook([FromBody] NotificationPayload notification)
    {
 // do something with the notification
    }
   ```
   
5. Use the URL for the `webhook` endpoint as the webhook URL when setting up webhooks on the Meta Developer portal (also enter matching verify token, apimatic-token-1234 in our case). You may use a service like [ngrok](https://ngrok.com/) to make your local app publicly accessible so this webhook can be registered with Whatsapp.


![alt text](https://res.cloudinary.com/apimatic/image/upload/v1655444404/6077d3bf745665b6417daf05/6077d3bf745665b6417daf05--Screenshot%202022-06-17%20at%2010.39.16%20AM.png)


6.  Retrieve your Access token from the Meta for Developers site  `App Dashboard > WhatsApp > Getting Started`

![alt text](https://res.cloudinary.com/apimatic/image/upload/v1655450016/6077d3bf745665b6417daf05/6077d3bf745665b6417daf05--281757444_734168554403466_603911146048087076_n%20%281%29%20%281%29.png)

7. Initialize the WhatsappClientAPI client and provide the Access token.
```
_client = WhatsAppCloudAPIClient.Builder()
                                .AccessToken(config.GetValue<string>("WhatsappAccessToken"))
                                .HttpClientConfig(config => config.NumberOfRetries(0))
                                .Build();
 ```  
 
8. Use the `SendMessageAsync` method from the SDK to setup the App to send a response whenever the webhook receives a message notification.
```
MessagesController messagesController = _client.MessagesController;

            var body = new Message();
         
                SendMessageResponse result = await messagesController.SendMessageAsync(_phoneNumberID, body);
          
```` 

This concludes the setup of the Whatsapp SDK to respond to incoming messages.
The next section describes how you can use OpenAI's API to generate responses for incoming messages.

## OpenAI Setup

1. Create an account with OpenAI and generate an Access token to use the [API](https://beta.openai.com/docs/api-reference/introduction).
2. Download the C# SDK from the [OpenAI APIMatic Portal](https://www.apimatic.io/apidocs/openai-api) and add it as a project to your Solution.
3. Instantiate an instance of the OpenAIAPIClient by providing the Access token you retrieved in step 1.
```
   _client = new OpenAIAPIClient.Builder().AccessToken(config.GetValue<string>("OpenAIAccessToken")).Build();
```

4. We will use the [Completions](https://beta.openai.com/docs/api-reference/completions) endpoint of the OpenAI API to generate relevant responses for received messages. Call the `CreateCompletionAsync` method of the OpenAI SDK inside the `POST webhook` to generate messages.  
```
  CreateCompletionResponse result = await _client.CreateCompletionAsync(body);
                return result.Choices.FirstOrDefault().Text;
 ``` 
 
5. Extract the Completion message generated by OpenAI and send the response to the sender.
```
MessagesController messagesController = _client.MessagesController;

            var body = new Message();
            body.MessagingProduct = "whatsapp";
            body.To = recipient;
            body.Type = MessageTypeEnum.Text;
            body.Text = new Text(message);

            try
            {
                SendMessageResponse result = await messagesController.SendMessageAsync(_phoneNumberID, body);
            }
            catch (ApiException e) { };
            
```